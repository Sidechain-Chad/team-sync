<div id="<%= dom_id(comment) %>" class="flex gap-3 mb-4 group"> <%# Avatar %>
  <div class="h-8 w-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs font-bold shrink-0">
    <%= comment.user.email.first(2).upcase %>
  </div>

  <div class="flex-1">
    <div class="flex items-baseline gap-2">
      <span class="font-bold text-sm text-gray-800"><%= comment.user.email.split('@').first %></span>
      <span class="text-xs text-gray-500"><%= time_ago_in_words(comment.created_at) %> ago</span>
    </div>

    <div class="text-sm text-gray-700 bg-white p-2 rounded-md shadow-sm border border-gray-200 mt-1 inline-block">
      <%= comment.content %>
    </div>

    <%# --- THE FIX IS HERE --- %>
    <%# We use (current_user rescue nil) to prevent crashing in background jobs %>
    <% if (current_user rescue nil) == comment.user %>
      <div class="mt-1 text-xs opacity-0 group-hover:opacity-100 transition-opacity">
        <%= link_to "Delete", card_comment_path(comment.card, comment),
            data: { turbo_method: :delete, turbo_confirm: "Delete?" },
            class: "text-red-500 hover:text-red-700 underline" %>
      </div>
    <% end %>
  </div>
</div>
